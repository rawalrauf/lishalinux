#!/bin/bash

set -e

trap 'echo ""; echo -e "\033[0;31mSomething went wrong during the update!\n\nPlease review the output above carefully, correct the error, and retry the update.\n\nIf you need assistance, get help from the community at https://lishalinux.org/discord\033[0m"' ERR

gum style --border normal --border-foreground 6 --padding "1 2" --margin "1 0" \
  "Ready to update LishaLinux?" \
  "" \
  "• You cannot stop the update once you start!" \
  "• Make sure you're not on battery power or have sufficient charge"

if ! gum confirm --default=false "Continue with update?"; then
  echo "Update cancelled"
  exit 0
fi

# Create pre-update important snapshot
PRE_SNAP=$(sudo snapper -c root create -c number -d "Pre-update important snapshot" --print-number)
sudo snapper -c root modify --userdata "important=yes" $PRE_SNAP
echo -e "\e[32mPre-update snapshot created: $PRE_SNAP\e[0m\n"

lishalinux-update-system-pkgs

# Create post-update important snapshot
POST_SNAP=$(sudo snapper -c root create -c number -d "Post-update important snapshot" --print-number)
sudo snapper -c root modify --userdata "important=yes" $POST_SNAP
echo -e "\e[32mPost-update snapshot created: $POST_SNAP\e[0m"
